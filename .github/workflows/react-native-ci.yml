name: React Native CI

on:
  push:
    branches: [ main ]
    paths: 
      - 'react-native/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'react-native/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (ubuntu-latest)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: react-native/yarn.lock
    
    - name: Install dependencies
      working-directory: react-native
      run: yarn install --frozen-lockfile
    
    - name: Run linting
      working-directory: react-native
      run: yarn lint

  build-android:
    name: Build Android (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: react-native/yarn.lock
    
    - name: Install dependencies
      working-directory: react-native
      run: yarn install --frozen-lockfile
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          react-native/android/.gradle
        key: gradle-${{ runner.os }}-${{ hashFiles('react-native/android/gradle/wrapper/gradle-wrapper.properties', 'react-native/android/**/*.gradle*') }}
        restore-keys: |
          gradle-${{ runner.os }}-
    
    - name: Build Android
      working-directory: react-native
      run: yarn build:android

  build-ios:
    name: Build iOS (macos-latest)
    runs-on: macos-latest
    needs: lint
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: react-native/yarn.lock
    
    - name: Install dependencies
      working-directory: react-native
      run: yarn install --frozen-lockfile
    
    - name: Cache CocoaPods dependencies
      uses: actions/cache@v4
      with:
        path: |
          react-native/ios/Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: cocoapods-${{ runner.os }}-${{ hashFiles('react-native/ios/Podfile.lock') }}
        restore-keys: |
          cocoapods-${{ runner.os }}-
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'
    
    - name: Install Ruby gems
      working-directory: react-native
      run: bundle install
    
    - name: Install CocoaPods
      working-directory: react-native/ios
      run: bundle exec pod install

    - name: Build iOS
      working-directory: react-native
      run: yarn build:ios

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: lint
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: react-native/yarn.lock
    
    - name: Install dependencies
      working-directory: react-native
      run: yarn install --frozen-lockfile
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'
    
    - name: Install Ruby gems
      working-directory: react-native
      run: bundle install
    
    - name: Install CocoaPods for macOS
      working-directory: react-native/macos
      run: bundle exec pod install

    - name: Build macOS
      working-directory: react-native
      run: yarn build:macos

  build-windows:
    name: Build Windows
    runs-on: windows-2022
    needs: lint
    timeout-minutes: 40
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: react-native/yarn.lock
    
    - name: Install dependencies
      working-directory: react-native
      run: yarn install --frozen-lockfile
    
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
    
    - name: Setup Visual Studio
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: |
          ~\.nuget\packages
          react-native\windows\packages
        key: nuget-${{ runner.os }}-${{ hashFiles('react-native/windows/**/*.csproj', 'react-native/windows/**/*.sln') }}
        restore-keys: |
          nuget-${{ runner.os }}-
    
    - name: Build Windows
      working-directory: react-native
      run: yarn build:windows