# Justfile for java-server quickstart
# Use PowerShell on Windows, bash on Unix

set windows-shell := ["powershell.exe", "-NoLogo", "-Command"]

artifact_base_path := "build/libs/quickstart-java"
version := if os() == "windows" { `(Get-Content gradle.properties | Select-String '^version' | ForEach-Object { $_ -replace 'version\s*=\s*', '' }).Trim()` } else { `grep '^version' gradle.properties | cut -d'=' -f2 | tr -d ' '` }

# List available recipes
@_default:
    just --list

# Build both JAR and WAR artifacts (skips tests)
build:
    ./gradlew bootJar bootWar -x test

# Build and run tests (requires Chrome browser for Selenium tests)
build-test:
    ./gradlew build

# Clean build artifacts
clean:
    ./gradlew clean

# Build with compilation checks but skip tests (recommended for local dev)
check:
    ./gradlew assemble check -x test

# Run the application (standalone JAR with embedded Tomcat)
run:
    ./gradlew bootRun

# Build and run the JAR file directly
run-jar: build
    java -jar "{{ artifact_base_path }}-{{ version }}.jar"

# Run the application Tomcat
run-war: build
    java -jar "{{ artifact_base_path }}-{{ version }}.war"

# Run integration tests (requires Chrome browser)
test:
    ./gradlew test

# Run integration tests with BrowserStack (requires BROWSERSTACK_USERNAME and BROWSERSTACK_ACCESS_KEY)
test-browserstack:
    ./gradlew test -DBROWSERSTACK_USERNAME="${BROWSERSTACK_USERNAME}" \
      -DBROWSERSTACK_ACCESS_KEY="${BROWSERSTACK_ACCESS_KEY}"

# Run linting checks
lint:
    ./gradlew pmdMain pmdTest spotbugsMain spotbugsTest

# Format code (if formatter is configured)
format:
    @echo "No formatter configured for this project"

# Show build info
info:
    ./gradlew -v

# Create JRE bundle for App-V deployment
jre-bundle:
    ./gradlew createJreBundle

# Build deployment package directory on Unix/macOS
[unix]
build-appv-package: build jre-bundle
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Creating deployment package..."
    rm -rf deploy/DittoQuickstart
    mkdir -p deploy/DittoQuickstart
    cp -r build/jre-bundle deploy/DittoQuickstart/
    cp "build/libs/quickstart-java-{{ version }}.jar" deploy/DittoQuickstart/
    cp launch.bat deploy/DittoQuickstart/
    cp install.bat deploy/DittoQuickstart/
    cp uninstall.bat deploy/DittoQuickstart/
    if [ -f .env ]; then
        cp .env deploy/DittoQuickstart/
    else
        echo "Warning: .env file not found. Copy manually to deploy/DittoQuickstart/"
    fi
    echo ""
    echo "Deployment package created: deploy/DittoQuickstart/"
    echo ""
    echo "Next step: Run 'just zip-package' to create distribution archive"

# Create ZIP archive on Unix/macOS
[unix]
zip-package: build-appv-package
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Creating ZIP archive..."
    cd deploy && zip -r ../build/DittoQuickstart-{{ version }}.zip DittoQuickstart/
    echo ""
    echo "Distribution package created:"
    echo "  ZIP: build/DittoQuickstart-{{ version }}.zip"
    echo ""
    echo "Deployment options:"
    echo "  1. Windows (without App-V): See WINDOWS-DEPLOYMENT.md"
    echo "  2. App-V Sequencer: See APP-V-DEPLOYMENT.md"

# Create ZIP archive on Windows
[windows]
zip-package: build-appv-package
    powershell -NoLogo -Command "Write-Host 'Creating ZIP archive...'; Compress-Archive -Path deploy/DittoQuickstart -DestinationPath build/DittoQuickstart-{{ version }}.zip -Force; Write-Host ''; Write-Host 'Distribution package created:'; Write-Host '  ZIP: build/DittoQuickstart-{{ version }}.zip'; Write-Host ''; Write-Host 'Deployment options:'; Write-Host '  1. Windows (without App-V): See WINDOWS-DEPLOYMENT.md'; Write-Host '  2. App-V Sequencer: See APP-V-DEPLOYMENT.md'"
